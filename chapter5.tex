% !TeX root = main.tex
%===================================== CHAP 5 =================================

\chapter{Simulation Results}\label{chap:simulation-results}

A comprehensive suite of simulation scenarios was designed to validate the B-spline MINMPC framework in dynamic obstacle encounters. First, the simulation environment and solver setup are detailed in \cref{sec:simulation-setup}. Then, trajectory generation around a stationary target is examined to illustrate the handling of non-convex constraints. Subsequent cases address COLREGS-relevant encounters: head-on approaches, crossing situations, and overtaking maneuvers. For each scenario, generated trajectories are evaluated in terms of path smoothness, constraint satisfaction, partial COLREGS compliance, thereby demonstrating the method’s robustness across diverse navigational challenges.


\section{Simulation Setup}\label{sec:simulation-setup}

The double integrator model in \cref{sec:double-integrator} is used to represent the OS, which has a maximum speed of 6 m/s. The spline representing the time $\mathbf t(x)$ is defined in the simplest way possible, as a linear function $\mathbf t(x) = Tx$, where $T$ is the total time of the simulation. As all functions in the optimization problem involving this variable only uses its derivative $\mathbf t'(x)$, $\mathbf t(x)$ can be represented by a single scalar variable $T$ in the optimization problem. 
More complex time splines are possible, giving more flexibility to the length and shapes of e.g. the maneuver windows, but this is not necessary for the simulation scenarios presented in this chapter.
In the different simulation scenarios, the TS heading and speed will vary to force the situations described by the COLREGS rules 8 and 13-17.

Unless otherwise specified, the bases for the spline functions in the optimization problem are given in \cref{tab:sim-spline-basis}. Note that the basis for the OS position $\mathbf p_\text{OS}$ is defined on finer knot vector as the normal and offset vectors for the TS hyperplanes, $\mathbf n_{s,j}$, $\mathbf n_{p,j}$, $b_{s,j}$, and $b_{p,j}$. This is done to reduce the number of optimization variables and constraints in the optimization problem, and is justified by the fact that this constraint is only active during a small time window at the closest point of approach (CPA) to the TS. For the given bases in \cref{tab:sim-spline-basis}, the OS position is represented by 12 B-spline basis functions of degree 2, so if the the TS hyperplane variables had the same basis, this would result in 72 optimization variables and 184 constraints
\footnote{The vector valued splines $\mathbf n_{s,j}$ and $\mathbf n_{p,j}$ give 12 $\times$ 2 = 24 coefficients each, and the scalar splines $b_{s,j}$ and $b_{p,j}$ give 12 $\times$ 1 = 12 coefficients each for a total of 72 optimization variables (73 if the binary variable is counted). The number of constraints are attributed to the following: 32 basis functions in the degree 4 basis of $\mathbf p_\text{OS}\cdot\mathbf{n}_{s,j}$, 4 $\times$ 22 = 88 from the 4 points defining the TS in the basis of $\mathbf p_\text{TS}\cdot\mathbf n_j$, and another 2 $\times$ 32 for the normalization of the normal vectors.}, 
as opposed to 36 optimization variables and 98 constraints per TS with the bases in \cref{tab:sim-spline-basis}.
The optimization problem in \cref{eq:minmpc-compact} is solved using Bonmin \citep{bonmin2008}, which combines existing open source libraries such as Ipopt \citep{ipopt2006} for NLPs, and Cbc \citep{cbc2005} for MIPs, to solve MINLPs. Bonmin is accessed through the CasADi framework as described in \cref{sec:python-implementation}. 
For all cases going forward, the solver is initialized as follows:
\begin{algorithmic}
    \centering
    \State $\mathbf p_\text{OS}(t) \gets \mathbf p_\text{ref}(t)$
    \For{each TS $j$}
        \State $\mathbf n_{s,j}(t) \gets -\mathbf{\hat n}_\text{ref}(t)$
        \State $\mathbf n_{p,j}(t) \gets \mathbf{\hat n}_\text{ref}(t)$
    \EndFor
\end{algorithmic}
All other optimization variables are initialized to zero. Notice the opposite signs for $\mathbf n_{s,j}(t)$ and $\mathbf n_{p,j}(t)$.
This choice ensures that the normal vectors are initialized pointing toward the OS reference from the TS constraints, which is always a feasible guess if the OS can follow the reference trajectory. 
The specific direction of the normals is reasoned from the definition of $\mathbf{\hat n}_\text{ref}(t)$ in \cref{eq:reference-normal}.

\renewcommand{\arraystretch}{1.2}
\begin{table}[htbp]
    \centering
    \begin{tabular}{|c|c|c|p{7cm}|}
        \hline
        \textbf{Parameter} & \textbf{Value} & \textbf{Unit} & \textbf{Description} \\
        \hline
        % \rule{0pt}{2.5ex}$k$ & 3 & - & Degree of the B-spline basis \\
        % \hline
        % \rule{0pt}{2.5ex}$N$ & 10 & - & Number of basis functions in the B-spline basis \\
        % \hline
        \rule{0pt}{2.5ex}$v_\text{max}$ & 6 & m/s & Own ship maximum speed \\
        \hline
        \rule{0pt}{2.5ex}$d_p$ & 50 & m & Minimum distance to target on the passing side \\
        \hline
        \rule{0pt}{2.5ex}$d_o$ & 100 & m & Minimum distance to target on the opposide side \\
        \hline
        \rule{0pt}{2.5ex}$w_\text{ref}$ & - & - & Weighting coefficients for the reference error in the cost function, see \cref{eq:minmpc-compact} \\
        \hline
        \rule{0pt}{2.5ex}$w_\text{mv}$ & - & - & Weighting coefficients for the control effort in the cost function, see \cref{eq:minmpc-compact} \\
        \hline
        \rule{0pt}{2.5ex}$w_\text{acc}$ & - & - & Weighting coefficient for the acceleration in the cost function, see \cref{eq:minmpc-compact} \\
        \rule{0pt}{2.5ex}$w_\text{time}$ & - & - & Weighting coefficient for the time in the cost function, see \cref{eq:minmpc-compact} \\
        \hline
    \end{tabular}
    \caption{Simulation parameters.}
    \label{tab:simulation-parameters}
\end{table}
\renewcommand{\arraystretch}{1.0}

\renewcommand{\arraystretch}{1.2}
\begin{table}[htbp]
    \centering
    \begin{tabular}{|p{2.5cm}||c|c|l|}
        \hline
            \rule{0pt}{2.5ex}
            \textbf{Spline Variable} & \multicolumn{3}{c|}{\textbf{B-spline Basis} $\mathbf{B}_{p, \mathbf t} = [B_{i, p, \mathbf t}(x)]_{i=0}^{N-1}$} \\[0.4ex]
            \hline
            & $N$ & $p$ & $\mathbf{t}$ \\
            \hline
            \hline
            \rule{0pt}{2.5ex}
            $\mathbf{p}_\text{OS}$
            & 12 & 2 & $\mathbf u(2,12)=\left\{0, 0, 0, \frac{1}{10}, \frac{2}{10}, \ldots, \frac{8}{10}, \frac{9}{10}, 1, 1, 1\right\}$ \\[1ex]
            \hline
            \parbox{2.5cm}{%
                $\mathbf{n}_{s, j}$, $\mathbf{n}_{p, j}$, \\
                $b_{s,j}$, $b_{p,j}$
            }
            & 6 & 1 & \rule{0pt}{3.5ex}$\mathbf u(6, 1) = \left\{0, 0, \frac{2}{10}, \frac{4}{10}, \frac{6}{10}, \frac{8}{10}, 1, 1\right\}$ \\[1ex]
            \hline
            $\mathbf{p}_\text{ref}$, $\mathbf{p}_\text{TS}$, & 2 & 1 & $\{0, 0, 1, 1\}$ \\
            \hline
            \rule{0pt}{2.5ex}
            $w_\text{ref}$, $w_\text{mv}$, $w_\mathrm{acc}$ & 10 & 0 & $\left\{0, \frac{1}{10}, \frac{2}{10}, \ldots, \frac{8}{10}, \frac{9}{10}, 1\right\}$ \\[1ex]
            \hline
            $\mathbf t'=T$ & 1 & 0 & $\{0, 1\}$ (or equivalently a constant) \\
            \hline
    \end{tabular}
    \caption{Spline functions and their B-spline bases used for the simulations.}\label{tab:sim-spline-basis}
\end{table}
\renewcommand{\arraystretch}{1.0}


\section{Simulation Results}\label{sec:simulation-results}

\subsection{Stationary Targets}
\label{sec:case-1-stationary-targets}

To demonstrate the B-MINMPC's ability to find optimal trajectories in non-convex environments, a stationary TS is placed at the position $(10, 0)$ in the simulation environment. The domain of the TS is set to 50m, and the OS is constrained to stay at least 10m away from this domain. COLREGS are not considered here, as only the qualitative behavior of the B-MINMPC is studied in cases 1.x. Both the Port and starboard maneuver directions are therefore considered as passing sides. The following cases 1.1-1.6 are variations of the first scenario, where 1.1-1.3 demonstrate the effect of changing the position of the TS. In the cases 1.4-1.6 the cost weight parameters are tuned to explore how maneuverside decisions are affected by the cost function. 
All varying parameters for the scenarios are listed in \cref{tab:stationary-targets}.


\begin{table}
    \centering
    \begin{tabular}{|c|c|c|c|c|c|c|}
        \hline
        Case & \multicolumn{2}{c|}{TS position} & $w_\text{time}$ & $w_\text{ref}$ & $w_\text{mv}$ & Plot \\
        \hline
        1.0 & (10, 0) & $-$ & 1 & 1 & 0 & \cref{fig:stationary-target} \\
        \hline
        1.1 & (10, 0) & $\mathbf{(-50, 0)}$ & 1 & 1 & 0 & \cref{fig:stationary-target-2} \\
        \hline
        1.2 & (10, 0) & $\mathbf{(-10, 200)}$ & 1 & 1 & 0 & \cref{fig:stationary-target-3} \\
        \hline
        1.3 & (10, 0) & $\mathbf{(10, 200)}$ & 1 & 1 & 0 & \cref{fig:stationary-target-4} \\
        \hline
        1.4 & (10, 0) & (-10, 200) & $\mathbf{100}$ & 1 & $1/100^2$ & \cref{fig:stationary-target-5} \\
        \hline
        1.5 & (10, 0) & (-10, 200) & 1 & $\mathbf{100}$ & $1/100^2$ & \cref{fig:stationary-target-6} \\
        \hline
        1.6 & (10, 0) & (-10, 200) & 1 & 1 & $\mathbf{1/100}$ & \cref{fig:stationary-target-7} \\
        \hline
    \end{tabular}
    \caption{Simulation cases for stationary targets. The first column indicates the case number, the second column indicates the position of the TS, and the subsequent three columns indicate the weights used in the optimization problem.}
    \label{tab:stationary-targets}
\end{table}


\begin{figure}
    \centering
    \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/1_stationary_obstacle.svg}
    \caption{\emph{Case 1.0}: Trajectory generation around a stationary target. }
    \label{fig:stationary-target}
\end{figure}

In Case 1.0 a solution is found that passes the TS on the south side. This is expected, as the center of the TS is located above the North=0 axis. Using the cost function based on the squared coefficients of the reference error and the trajectory is free of oscillations (The other case with the definite integral cost is not shown). This is shown in \cref{fig:stationary-target} with the blue trajectory. The colored arrows indicate the direction of the trajectory and serve as time-stamps  spaced 60 seconds apart. These are present in all North-East plots in this chapter, and in cases where there are multiple trajectories, the same color represents the same time stamp. 


\begin{figure}[hbtp]
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_above_both.svg}
        \caption{\emph{Case 1.1}: Trajectory generation around two stationary targets (above both).}
        \label{fig:stationary-target-2}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_between.svg}
        \caption{\emph{Case 1.2}: Trajectory generation around two stationary targets (between).}
        \label{fig:stationary-target-3}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_below_both.svg}
        \caption{Trajectory generation around two stationary targets (below both).}
        \label{fig:stationary-target-4}
    \end{subfigure}
    \caption{\emph{Case 1.3}: Trajectory generation around two stationary targets in different configurations.}
    \label{fig:stationary-targets-subfigures}
\end{figure}

\todo[inline]{generer nye plot som representerer det som er skrevet i figurteksten.}

Cases 1.1-1.3 in \cref{fig:stationary-targets-subfigures} introduces a second TS. Here it is demonstrated that for the same initial conditions and parameters, the B-MINMPC finds different solutions regarding starboard and port passing depending on the position of the second TS\todo{endre kostfunksjonen igjen slik at dette faktisk skjer}. This is the main goal of this constraint formulation in this work. 

Cases 1.4-1.6 in \cref{fig:stationary-targets-subfigures-2} show the effect of changing the weights of the cost function. In \cref{fig:stationary-target-5} $w_\text{time}$ is set to 100, which means that minimizing the total time of the trajectory is prioritized. This results in a trajectory that passes both TSs with a starboard maneuver, as this is the fastest route. Another effect of this is that the trajectory is more aggressive, yielding sharp turns between straight segments. With $w_\text{ref}$ set to 100 in case 1.5, (\cref{fig:stationary-target-6}), the solution trajectory passes between the two TSs, as this yields the lowest overall reference error. The same argument can be made for case 1.6 from \cref{fig:stationary-target-7}, where $w_\text{mv}$ is set to $1/100$, a port side maneuver is chosen to minimize the control effort. This is a result of how the TS at $(-10, 200)$ is positioned with a bias towards the south close to the end of the reference trajectory, and so a less agressive maneuver is possible on the northern side. \todo{endre kostfunksjonen igjen slik at dette faktisk skjer}

In all cases, while being initialized with the reference, the B-MINMPC is able to find a solution that passes the TSs while respecting the constraints. In other words, using the mixed integer constraints presented in \cref{sec:collision-constraints} and a simple initialization scheme, a convex optimizer is able to more robustly find the optimal solution in a non-convex environment than a convex optimizer without these constraints. This is an improvement over the previous work in \cite{Thyri2022-MPC,prosjektoppgave} where a carefully crafted initial guess had to be construced to facilitate a maneuver towards the desired passing side.
\todo{diskuter at det er vanskelig med metrikker for tidlig manøver. Si hvorfor vi ikke bruker metrikker.}
\todo{kan drøfte total bruk av hstighetsendring, vs total kursendring.}
\todo[inline]{poengter at der er like høy kompleksitet i å lage metrikker for colregs compliance som en colregs compliant motion planner, fordi colregs er skrevet for mennesker. Bygger på kapteinens tolkning av situasjonen. lite vennlig for programmering. Kyle Vohler har lagd metrikker, men de er tuningavhengig.}
\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_high_time_ref_ratio.svg}
        \caption{\emph{Case 1.4}: Trajectory generation around two stationary targets (high time reference ratio).}
        \label{fig:stationary-target-5}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_low_time_ref_ratio.svg}
        \caption{\emph{Case 1.5}: Trajectory generation around two stationary targets (low time reference ratio).}
        \label{fig:stationary-target-6}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/stationary_obstacle/2_stationary_obstacles_high_acc.svg}
        \caption{\emph{Case 1.6}: Trajectory generation around two stationary targets (high acceleration).}
        \label{fig:stationary-target-7}
    \end{subfigure}
    \caption{Trajectory generation around two stationary targets in different configurations.}
    \label{fig:stationary-targets-subfigures-2}
\end{figure}


\FloatBarrier
\subsection{Head-on, Crossing, and Overtaking Situations}
\label{sec:case-2-head-on}


Evaluating the compliance of autonomous vessels with the COLREGS through formal, quantifiable metrics presents substantial challenges. The COLREGS were originally formulated to guide human mariners, yielding a set of rules that invite subjective interpretation, resist quantification, and complicate systematic evaluation \citep{Woerner2018}.  For example, the customary practice of smaller craft yielding to larger intercontinental vessels often prevails even when protocols can assign right-of-way to the smaller vessel, underscoring the human-centric nature of these rules. \citet{Woerner2018} propose several compliance‐assessment techniques---such as computing an optimal vessel pose at the \acrshort{CPA} and defining safety functions based on inter-vessel range and relative bearing---but these methods introduce numerous scenario-specific parameters that must be manually tuned according to human evaluators' judgments, thereby limiting their robustness and general applicability.


Assessing COLREGS compliance in motion planners via post hoc metrics inevitably introduces circularity: each metric must be tailored to the specific scenario it evaluates, and a good planner should be designed to optimize the same metric. 
As a result, metric design becomes as bespoke and complex as developing a COLREGS-compliant motion planner itself, precluding truly objective assessment.  As an example, take the simple case of a minimum distance requirement: When a distance constraint is correctly encoded in the optimization problem, the passing distance is guaranteed to hold by the constrained optimization, while if the distance requirement in the optimization problem is too small, it may lead to a dangerous situation in the real world.  If the minimum distance requirement is known through the metric, it may as well be encoded in the optimization problem, rendering the metric redundant. 
Instead of relying on such tuning-dependent measures, the intrinsic geometric and kinematic properties of the optimized trajectories are analyzed.  Given a set of metrics and requirements, the B-MINMPC can---by only tuning the parameters in \cref{tab:simulation-parameters}---be configured to reliably generate trajectories that are compliant with COLREGS 
parameterized to generate trajectories

% In particular, the cumulative ratio of speed change to course change is introduced, a parameter-free indicator that depends solely on the trajectory’s shape and can be computed directly from the solution.



The next cases serve to illustrate the robustness of the B-MINMPC in situations where COLREGS rules 8 and 13-17 are applicable. These are constructed such that an OS following an eastwards reference trajectory at $N=0$ is on a collision course with a TS at $(0, 0)$, 250 seconds into the simulation. For each scenario, eight additional simulations are run where the starting points and reference trajectories for the OS are shifted both north and south by an appropriate distance. The shifted scenarios will all be referred to as belonging to the same \emph{batch simulation}.
In these scenarios, the simulation time is fixed to $T=500$ seconds to precisely control the timing of maneuver and encounter windows. \Cref{tab:batch-params} summarizes the parameters for each case. The weights in \cref{tab:sim-spline-basis} are configured as follows:
\begin{subequations}
    \begin{align}
        w_\text{time} &= 0 \quad \text{(\emph{fixed simulation time})}  \\
        \coeffs(w_\text{ref}) &= [10, 0, 0, 0, 0, 0, 0, 0, 0, 10]^\top     \\
        \coeffs(w_\text{mv}) &= [1, 0, 0, 0, 1, 1, 0, 0, 0, 1]^\top      \\
        \coeffs(w_\text{acc}) &= \begin{bmatrix}0, 0, \frac{1}{10}, 0, 0, 0, 0, \frac{1}{10}, 0, 0\end{bmatrix}^\top
    \end{align}
\end{subequations}
These settings promote course corrections within the maneuver windows, as detailed in \cref{sec:colregs-objectives}.  Specifically, they define an encounter window of duration $(t_8-t_2)T=(0.8-0.2)500=300$ seconds and maneuver windows of duration $(t_3-t_2)T=(t_7-t_6)T=(0.3-0.2)500=50$ seconds. The increased weight on $w_\text{mv}$ within the central portion of the encounter window encourages the OS to maintain its reference speed, facilitating course alterations during the maneuver windows in accordance with COLREGS rule 8c). This rule states that if there is sufficient sea room, alteration of course alone may be the most effective action to avoid collision \citep{COLREGS}. The weights on the acceleration $w_\text{acc}$ are set to promote a constant speed and heading between the course alterations, further constraining where the OS can maneuver. Together, these weights divide the TS encounter into nine distinct phases:
\begin{enumerate}[itemsep=0.2ex, topsep=0.5ex, parsep=0pt]
    \item Initial reference following
    \item Evasive course alteration
    \item Lateral distancing maneuver
    \item Course alteration towards reference course
    \item Parallell transit alongside reference
    \item Course alteration towards reference
    \item Re-approach to reference trajectory
    \item Final course correction
    \item Resumtion of reference following
\end{enumerate}
 


\begin{figure}
    \centering
    \includesvg[width=\textwidth,pretex=\footnotesize]{fig/illustrations/weight_functions.svg}
    \caption{Support of the weighting functions for PXTE $w_\text{ref}$, reference speed $w_\text{mv}$, and acceleration $w_\text{acc}$ in the cost function.}
    \label{fig:weight-functions}
\end{figure}



\renewcommand{\arraystretch}{1.0}
\begin{table}[htbp]
    \centering
    \small
    \begin{tabular}{|c|r|l|l|l|l|}
        \hline
        \textbf{Case} & \multicolumn{1}{c|}{\textbf{TS course}} & \textbf{TS speed} & \textbf{OS Basis} & \multicolumn{1}{c|}{\textbf{Figures}} & \multicolumn{1}{c|}{\textbf{Description}} \\
        \hline
        2.0 & -40\degree, 20\degree, 40\degree & 4.5 m/s & $\mathbf B_{\mathbf u(2,12)}$ & \cref{fig:crossing} & Base Crossing scenario \\
        \hline
        2.1 & 40\degree & 4.5 m/s & $\mathbf{B}_{3, \mathbf u(3, 13)}$ & \Cref{fig:crossing-scenario-degree-3-metrics,fig:crossing-advanced-scenario-10-3} & Degree 3 basis \\
        \hline
        2.2 & 40\degree & 4.5 m/s & $\mathbf{B}_{2, \mathbf u(2, 22)}$ & \Cref{fig:crossing-advanced-scenario-20-2,fig:crossing-advanced-scenario-20-2-traj} & Refined degree 2 basis \\
        \hline
        2.3 & 40\degree & 4.5 m/s & $\mathbf{B}_{3, \mathbf u(3, 23)}$ & \Cref{fig:crossing-advanced-scenario-20-3,fig:crossing-advanced-scenario-20-3-traj} & Refined degree 3 basis \\
        \hline
        3.0 & -90\degree & 4.5 m/s & $\mathbf B_{\mathbf u(2,12)}$ & \cref{fig:head-on} & Head-on scenario \\
        \hline
        4.0 & 75\degree & 4.0 m/s & $\mathbf B_{\mathbf u(2,12)}$ & \cref{fig:overtaking} & Overtaking scenario \\
        \hline
    \end{tabular}
    \caption{Simulation parameters for the head-on, crossing, and overtaking cases. The function $\mathbf u(p,n)$ generates a uniform degree $p$ basis with $n$ basis functions.}\label{tab:batch-params}
\end{table}
\renewcommand{\arraystretch}{1.0}


\begin{figure}[htbp]
    \centering
\includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/crossing_advanced/crossing_advanced_scenario_10_2.svg}
    \caption{\emph{Case 2.0}: Trajectory generation in a crossing situation where the TS has a course, from top to bottom, of -40\degree, 20\degree, and 40\degree with respect to the North axis.}
    \label{fig:crossing}
\end{figure}



Case 2 is a crossing situation where the TS is heading west at 4.5 m/s with a heading $-90\degree$. For the sake of simplicity, the OSs starting above the $N=250$ axis are considered to be too far away to be in a situation requiring a COLREGS compliant maneuver, and so only the OSs starting south of the $N=250$ axis are considered. In a crossing situation, COLREGS rule 15 applies, which states that the OSs must pass the TS with a starboard maneuver. To encourage this behaviour the minimum passing distances for the port and starboard maneuver are enforced by setting $d_p=50$ m and $d_o=100$ m respectively. The specific distances are not important, as they are heavily dependent on the environment and the speeds and sizes of the OS and TSs, and have to be tuned specifically for each scenario. The important part is that the port side passing distance is larger than the starboard side passing distance, and that the port side passing distance is not so large that no solution to the optimization problem can be found given that the starboard side solution is deemed infeasible by the optimizer.


\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/metrics/crossing_advanced_scenario_10_2_course_40.svg}
        \caption{\emph{Case 2.0:} B-Spline basis as given in \cref{tab:sim-spline-basis}. Trajectory shown in \cref{fig:crossing} in the $40\degree$ course case.}
        \label{fig:crossing-metrics}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/metrics/crossing_advanced_scenario_10_3_course_40.svg}
        \caption{\emph{Case 2.1:}  Case 2.0 with $\mathbf p_\text{OS}$ parameterized with a degree 3 basis. Trajectory shown in \cref{fig:crossing-advanced-scenario-10-3} in \cref{app:additional-simulation-plots}.}
        \label{fig:crossing-scenario-degree-3-metrics}
    \end{subfigure}
    \caption{Speed, change in course, and distance to the reference trajectory for the OSs in crossing scenario. The dotted lines represent the knots in the B-spline basis for the OS position $\mathbf p_\text{OS}$, and the colored solid lines each represent a single OS starting at the corresponding North coordinate given in the legend.}
    \label{fig:crossing-scenario-metrics}
\end{figure}


\subsubsection{Case 2.0: Crossing Scenario}
\Cref{fig:crossing} shows the optimal trajectories under the settings in Case 2.0 of the OSs and TS in a crossing situation. At $t=50$ seconds, the five OSs closest to $N=150$ start the starboard maneuver, and follows a course parallell to the reference trajectory from $t=200$ until the start of the second maneuver window at $t=300$ seconds where the OSs start to turn back towards their reference trajectories. This is further emphasized in \cref{fig:crossing-metrics}, where the speed, change in course, and distance to the reference trajectory for the OSs are plotted for the case where the TS has a course of 40\degree in \gls{NED} coordinates. What follows is an analysis of the trajectory properties for Case 2.0 and how the speed and course changes relate to COLREGS 8b) and 8c).

The change in course is concentrated at the beginning and end of each maneuver window. This behavior aligns with COLREGS 8b), which advises that any alteration of course or speed should be substantial enough to be readily apparent to another vessel, as opposed to a gradual and subtle change.  The course change happens over a period of 50 seconds, which is the shortest possible duration any speed or course change can take in this simulation. This is a result of the OS position $\mathbf p_\text{OS}$ being parameterized by a B-spline with a knot interval of 0.1 and the total simulation time being 500 seconds. A notable weakness with this sparse parameterization is that the course change is smaller for the cases where the OS doesn't have to maneuver as far off the reference trajectory to avoid the TS. 
This is true for the southernmost OSs in Case 2.0 where these parameters result in only $\approx3\degree$ of course deviation from the reference over $t=50$–100\,s for the OS starting at $N=-50\,$m, versus $\approx27\degree$ at $N=250\,$m. Refinement of the B-spline basis for $\mathbf p_\text{OS}$ (see Case 2.2) increases control-point density, enabling more localized course and speed adjustments, addressing this issue.

Under COLREGS 8b), a $3\degree$ alteration over 50\,s  may be insufficiently conspicuous. To remedy this, two obvious extensions to the cost functions are (i) imposing a temporary course reference during maneuver windows and (ii) specifying a target offset from the reference path at the encounter midpoint. Both require additional cost terms and user‐tuned parameters, increasing scenario‐specific complexity and undermining the planner’s flexibility. The current objective merely incentivizes---rather than enforces---course deviations, permitting an OS to maintain its heading when a maneuver is unnecessary (as seen for the extreme OSs in \cref{fig:crossing}). Unless maneuver necessity is known a priori, such constraints risk inducing spurious maneuvers. These refinements are deferred to future work; the present formulation already demonstrates robust trajectory generation given a suitible subset of COLREGS‐related metrics.


The speed is kept close to the reference speed of 6 m/s during the segments where the OSs are not maneuvering, but dips below the reference speed during course change.  This is undesirable in context of COLREGS 8c) if there is sufficient sea room, as the OSs should prioritize altering course alone over altering speed.  This is uniquely a result of the B-Spline parameterization. For a constant speed trajectory, the equation
\begin{equation}
    u^2(x) + v^2(x) = C
\end{equation}
must hold, where $u(x)$ and $v(x)$ are the speeds of a vessel in two orthogonal directions, and $C$ is a constant. This equation has solutions of the form
\begin{equation}
  u(x) = \sqrt{C}\,\cos\varphi(x), 
  \quad
  v(x) = \sqrt{C}\,\sin\varphi(x),
\end{equation}
where $\varphi(x)$ is an arbitrary (sufficiently smooth) function of $x$.  B-Splines are piecewise polynomials and cannot represent trancendental functions such as sines and cosines.  This explains the small dips in speed during the course change segments. During the straight segments,  
Even PH B-splines, which has a piecewise polynomial representation of the speed, cannot represent a constant speed trajectory in a non-trivial way as they are still fundamentally B-splines.  The same is also true for NURBS, which while they can represent circular and elliptical arcs perfectly, cannot do so with a constant speed parameterization due to the same reasons as above.  This is a fundamental limitation of B-splines and NURBS, and not a limitation of the B-MINMPC itself.  The speed dips during the course change segments can indirectly be mitigated by refining the B-spline basis for $\mathbf p_\text{OS}$, which under acceleration constraints gives a smaller angle between the control points, and thus a smaller speed reduction. This is explained in more detail in Case 2.2.



\begin{figure}
    \centering
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/metrics/crossing_advanced_scenario_20_2_course_40.svg}
        \caption{\emph{Case 2.2}: Uniform degree 2 basis with 22 basis functions for the OS position $\mathbf p_\text{OS}$. Trajectory shown in \cref{fig:crossing-advanced-scenario-20-2-traj} in \cref{app:additional-simulation-plots}.}
        \label{fig:crossing-advanced-scenario-20-2}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/metrics/crossing_advanced_scenario_20_3_course_40.svg}
        \caption{\emph{Case 2.3}: Same scenario as Case 2.2, but with a B-spline basis of degree 3 for $\mathbf p_\text{OS}$. Trajectory shown in \cref{fig:crossing-advanced-scenario-20-3-traj} in \cref{app:additional-simulation-plots}.}
        \label{fig:crossing-advanced-scenario-20-3}
    \end{subfigure}
    \caption{Speed, change in course, and distance to the reference trajectory for the OSs in crossing scenario. The dotted lines represent the knots in the B-spline basis for the OS position $\mathbf p_\text{OS}$, and the colored solid lines each represent a single OS starting at the corresponding North coordinate given in the legend.}
    \label{fig:crossing-advanced-scenario-metrics}
\end{figure}


\subsubsection{Case 2.1: Degree 3 Basis for $\mathbf p_\text{OS}$}
As per \cref{tab:sim-spline-basis}, the basis for $\mathbf p_\text{OS}$ is degree 2, which gives a continuous function for position, speed and course, but is discontinuous at the knots for acceleration and course change (also seen in \cref{fig:crossing-metrics}). 
If such discontinuities are undesirable, increasing the B-spline basis degree enhances continuity at the expense of additional constraints. A higher basis degree necessitates a finer knot vector to maintain maneuver window locality, as continuity conditions introduce dependencies between neighboring control points. \Cref{fig:crossing-scenario-degree-3-metrics} illustrates this trade-off, showing a continuous course change $\dot\chi$ but extended maneuver duration with a degree 3 B-spline basis for $\mathbf p_\text{OS}$. 
The initial maneuver in the first window results in a more significant speed reduction, dropping to approximately 4.2 m/s. Subsequently, the OSs maintain a course parallel to the reference trajectory without reconverging. After further inspection it was found that the acceleration cost in $t\in[350, 400]$ s inhibits trajectory convergence. 
Comparing \cref{fig:crossing-metrics} and \cref{fig:crossing-scenario-degree-3-metrics} reveals that the discontinuous course change $\dot{\chi}$ in the former allows the OSs to sharply revert to $\dot{\chi}=0$ between maneuvers, where the acceleration cost is active, whereas the continuity constraints in the latter force a smoother transition. This creates conflicting objectives between minimizing acceleration and converging back to the reference trajectory, and in this case---with the given parameters---the acceleration cost is prioritized over the reference trajectory convergence. The basis is in other words too coarse to allow for a degree 3 parameterization of $\mathbf p_\text{OS}$ with these parameters.

\subsubsection{Case 2.2: Refined Degree 2 Basis for $\mathbf p_\text{OS}$}
As mentioned, a finer knot vector for $\mathbf p_\text{OS}$ localizes the course change, and allows for the degree 3 parameterization to be used without the acceleration cost conflicting with the reference trajectory convergence. This is demonstrated in Case 2.2, where the knot vector for $\mathbf p_\text{OS}$ is refined to 22 knots, while the degree of the B-spline basis is kept at 2. The results are shown in \cref{fig:crossing-advanced-scenario-20-2} where the speed, course change, and distance to the reference trajectory for the OSs are plotted. The trajectory is shown in \cref{fig:crossing-advanced-scenario-20-2-traj}. 

With the refined basis, the course change exhibits piecewise continuity over 25-second intervals. As depicted in \cref{fig:crossing-advanced-scenario-20-2}, the OS originating at $N=250$ m achieves a course alteration of $27\degree$, mirroring the result in \cref{fig:crossing-metrics}. However, this change now occurs over a compressed timeframe of $t=50-75$ seconds, effectively doubling the rate of course alteration. This observation encapsulates the trend associated with refining the B-spline basis for $\mathbf p_\text{OS}$: the localization of course changes intensifies until the acceleration constraints become active.

The refined basis does not at all mitigate the speed reduction during maneuvers; the speed still decreases to approximately 4.8 m/s during course alterations. This phenomenon can be analyzed by examining the relationship between the speed and the consecutive control points of $\mathbf p_\text{OS}$, as well as the angle between these control points.

Let $P_i,P_{i+1},P_{i+2}\in\mathbb R^2$ be the three consecutive control points affecting the $i$-th spline segment on a uniform quadratic B-spline with knot interval length $h$.  Over $t\in[t_{i+1}, t_{i+2}]$, the derivative of $\mathbf p_\text{OS}(t)$ is given by
\begin{equation}
    \begin{aligned}
        \mathbf p_\text{OS}'(t) 
        &=\frac{t_{i+2}-t}{h^2}\;(P_{i+1}-P_i) 
        +\frac{t - t_{i+1}}{h^2}\;(P_{i+2}-P_{i+1})\\
        &=\frac{t_{i+2}-t}{h}\;P'_0
        +\frac{t - t_{i+1}}{h}\;P'_1,
    \end{aligned}
\end{equation}
where
\begin{equation}
P'_i = \tfrac1h (P_{i+1} - P_i),
\qquad
P'_{i+1} = \tfrac1h(P_{i+2} - P_{i+1}).
\end{equation}
When the maximum speed constraint on $\mathbf p_\text{OS}$ is active: $\|P'_i\|=\|P'_{i+1}\|=v_{\max}$ .  Let $\theta\in[0,\pi]$ be the smallest angle between the three consecutive points $P_i,P_{i+1},P_{i+2}$ so that
\begin{equation}
P'_i\cdot P'_{i+1} = v_{\max}^2\cos\theta.
\end{equation}
Then one shows by differentiating $\|\mathbf p'_\text{OS}(t)\|_2^2$ that the minimal speed $v_{\min}$ occurs at $t^*=\tfrac12(t_{i+1}+t_{i+2})$ and is given by
\begin{equation}
v_{\min}
=\Bigl\|\tfrac12(P'_i+P'_{i+1})\Bigr\|
=v_{\max}\sqrt{\frac{1+\cos\theta}{2}}
=v_{\max}\cos\Bigl(\tfrac\theta2\Bigr).
\end{equation}
As the derived expressions for $t^*$ and $v_{\min}$ are independent of $h$, the knot interval, the minimum achievable speed is solely dependent on the turning angle $\theta$ and the maximum speed $v_{\max}$. Consequently, mitigating speed reduction during maneuvers necessitates a reduction in $\theta$ between successive control points. While knot refinement alone is insufficient, it facilitates closer approximation of the spline by the control points. This, in turn, allows the constraint on the maximum acceleration of the OS to effectively limit the angle between consecutive control points, thereby reducing the speed reduction during maneuvers.


\subsubsection{Case 2.3: Refined Degree 3 Basis for $\mathbf p_\text{OS}$}
The situation in Case 2.1 for a 13 control point degree 3 basis for $\mathbf p_\text{OS}$ is remedied by refining the basis to 23 control points, as shown in \cref{fig:crossing-advanced-scenario-20-3}. The course change is still restricted to the maneuver windows by the weights on PXTE, reference speed, and acceleration, but in this case the refined basis allows the continuous course change to occur entirely within these windows, and the OS thus converges properly back to the reference as intended.


\subsubsection{Cases 2 and 3: Head-on and Overtaking Situations}
Similar results are seen for the crossing and overtaking cases, where the only differences are number of OSs that have to maneuver and the distances they have to travel to avoid the TS. These scenarios are run with the same weight parameters as Case 2.0 (see \cref{tab:batch-params}), but with different TS courses and speeds. For completeness' sake the results are shown in \cref{fig:head-on} and \cref{fig:overtaking} for the head-on and overtaking cases respectively. 


\todo[inline]{ikke passer 200m foran beamen + en hastighetsfaktor. Kan gå nærme bak dersom det har skjedd en manøver nærme CPA, men er vanskelig å vurdere om denne manøveren er stor nok. DNV}
\todo{søk på litteratur (DNV) om colregs. Tom Arne Pedersen. 95280695}




\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/Head on scenario.svg}
        \caption{Axes are scaled proportionally to each other.}
        \label{fig:head-on-scenario-a}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \centering
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/Head on scenario free scale.svg}
        \caption{North axis stretced for better visualization of maneuver timings.}
        \label{fig:head-on-scenario-b}
    \end{subfigure}
    \caption{\emph{Case 3}: Trajectory generation in a head-on situation.}
    \label{fig:head-on}
\end{figure}




\begin{figure}[htbp]
    \centering
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/Overtaking scenario.svg}
        \caption{Axes are scaled proportionally to each other.}
        \label{fig:overtaking-scenario-a}
    \end{subfigure}
    \begin{subfigure}[b]{\textwidth}
        \includesvg[width=\textwidth,pretex=\footnotesize]{fig/scenarios/Overtaking scenario free scale.svg}
        \caption{North axis stretced for better visualization of maneuver timings.}
        \label{fig:overtaking-scenario-b}
    \end{subfigure}
    \caption{\emph{Case 4}: Trajectory generation in an overtaking situation.}
    \label{fig:overtaking}
\end{figure}




\section{Confined Waters}


\section{Pure Reference Following}


\section{PH B-Spline OS Model}
Does not work well :(

\section{Summary}

mixed integer -reliable to find solutions in non-convex environments

weight functions - a lot of control on the shape of the resulting trajectory, but also a lot of parameters to tune, and is situation dependent. Choice of basis allows arbitrary continuity of the trajectory, but care must be taken to match knot vector and basis degree so that the chosen fidelity of the trajectory is sufficient to allow for the desired maneuvers.
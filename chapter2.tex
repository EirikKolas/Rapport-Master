% !TeX root = main.tex
%===================================== CHAP 2 =================================

\chapter{The B-spline}
\label{chap:b-spline-theory}
This chapter will introduce B-splines, a type of spline function that is widely used in computer graphics, computer-aided design, and numerical optimization. B-splines are piecewise polynomial functions that are defined recursively in terms of a degree $p$ and a set of so-called knots. The chapter will cover the definition of B-splines, their properties, and common operations that can be performed on them. 

Important properties and operations on B-splines are presented, providing discussion and intuition around results and theorems without going into the full mathematical details. The goal is to provide the reader with the necessary background to understand the subsequent chapters in addition to being able to implement B-splines in a numerical optimization context from scratch.

\section{Definition and Properties}
The following definition is from \cite{Grimstad2016}:
A B-spline $f: \mathbb R \rightarrow \mathbb R$ is given by $n$ \emph{B-spline coefficients} $\mathbf c = [c_j]_{j=0}^{n-1}$ and $n+p+1$ non-decreasing knots $\mathbf t = [t_j]_{j=0}^{n+p}$ as follows:

\begin{equation}\label{eq:b-spline-def}
    f(x ; \mathbf{c}, p, \mathbf{t})=\sum_{j=0}^{n-1} c_j B_{j, p, \mathbf{t}}(x)=\mathbf{c}^{\top} \mathbf{B}_{\mathrm{p}, \mathrm{t}}(\mathrm{x})
\end{equation}

When the parameters $\mathbf{c}, p$, and $\mathbf{t}$ are given by the context, $f(x ; \mathbf{c}, p, \mathbf{t})$ is simply denoted $f(x)$. The sequence of coefficients $c_j$ control the shape of the B-spline, and the degree $p$ is a non-negative integer. The B-spline basis functions $B_{j, p, \mathbf{t}}(x)$ are defined recursively in terms of the degree $p$ and the knots $\mathbf t$ to form the column vector $\mathbf{B}_{p, \mathbf{t}}(x) = [B_{j, p, \mathbf{t}}(x)]_{j=0}^{n-1}$. 
in \cref{eq:b-spline-def}. These B-spline basis functions are defined as

\begin{subequations}\label{eq:b-spline-recurrence}
    \begin{align}
        B_{j, p, \mathbf{t}}(x) & =\frac{x-t_j}{t_{j+p}-t_j} B_{j, p-1, \mathrm{t}}(x)+\frac{t_{j+1+p}-x}{t_{j+1+p}-t_{j+1}} B_{j+1, p-1, \mathrm{t}}(x) \label{eq:b-spline-recurrence-p} \\
        B_{j, 0, \mathbf{t}}(x) & := 
        \mathbf 1_{[t_j, t_{j+1})} =
        \begin{cases}
            1, & t_j \leq x<t_{j+1} \\
            0, & \text { otherwise }
        \end{cases} \label{eq:b-spline-recurrence-0}
    \end{align}
\end{subequations}

From \cref{eq:b-spline-recurrence}, it is clear that the B-spline basis functions are all non-negative, as \cref{eq:b-spline-recurrence-0} gives $B_{j, 0, \mathbf{t}}(x) \geq 0 \quad\forall j, x$, and the coefficients $\frac{x-t_j}{t_{j+p}-t_j}$ and $\frac{t_{j+1+p}-x}{t_{j+1+p}-t_{j+1}}$
in \cref{eq:b-spline-recurrence-p} are also non-negative $\forall x, j\in[0,\dots,n-1], p, \mathbf t$ by the non-decreasing condition on the knots $\mathbf t$. 

\Cref{eq:b-spline-recurrence} also implies $B_{j, p, \mathbf{t}}(x)$ has local support on the interval $[t_j, t_{j+p+1})$. This can be seen by noting that the support of $B_{j, 0, \mathbf{t}}$, $\text{supp}(B_{j, 0, \mathbf{t}}) = [t_j, t_{j+1})$ and for each of the $p$ recurrence steps in \cref{eq:b-spline-recurrence-p}, the support is extended by one knot. 

It can also be shown that the B-spline basis functions are a partition of unity, i.e. $\sum_{j=0}^{n-1} B_{j, p, \mathbf{t}}(x) = 1 \quad\forall x \in [t_0, t_{n+p})$ \citep{deBoor1978practicalguide}.

These properties are well-documented in the literature and are summarized as follows:
\begin{property}[Nonnegativity]\label{b-prop:nonnegativity}
    $B_{j, p, \mathbf{t}}(x) \geq 0 \quad\forall j, p$, and $x$.
\end{property}

\begin{property}[Local support]\label{b-prop:localsupport}
    $B_{j, p, \mathbf{t}}(x)=0 \quad\forall x \notin [t_j, t_{j+p+1})$.
\end{property}

\begin{property}[Partition of unity]\label{b-prop:partitionofunity}
    $\sum_{j=i-p}^i B_{j, p, \mathbf{t}}(x)=1 \quad\forall x \in [t_i, t_{i+1})$.
\end{property}

So far, only B-splines with a one-dimensional co-domain have been considered. However, B-splines can be extended to curves in higher dimensions by simply allowing the coefficients $c_j$ to be vectors. In this case the B-spline is a vector-valued function $f: \mathbb R \rightarrow \mathbb R^m$. The \cref{b-prop:nonnegativity,b-prop:localsupport,b-prop:partitionofunity} still hold, as the basis functions themselves are still scalar-valued.

\begin{figure}
    \centering
    \includesvg[width=0.8\textwidth]{fig/b-spline/knots + control points.svg}
    \caption{A 3rd degree B-spline (full) with 4 control points, knot vector \raggedright{$\mathbf t = [0, 0, 0, 0.5, 1, 1, 1]$} and corresponding control polygon (dashed).}
    \label{fig:b-spline-knots-control-points}
\end{figure}

Together, \cref{b-prop:nonnegativity,b-prop:partitionofunity} imply that the B-spline in \cref{eq:b-spline-def} is a convex combination of the coefficients $\mathbf c$. This means that the B-spline is always within the convex hull of the control points $\mathbf c$.

\begin{property}[Convex hull]\label{b-prop:convexhull}
    $f(x) \in \text{conv}(\mathbf{c})
    \quad\forall x$.
\end{property}

The convex hull $\text{conv}(\mathbf{c})$ of a set of points $\mathbf{c} = \{c_1, c_2, \ldots, c_n\}$ is defined as the set of all convex combinations of the points. Mathematically, it is given by:

\begin{equation}
    \text{conv}(\mathbf{c}) = \left\{ \sum_{i=1}^n \lambda_i c_i \mid \lambda_i \geq 0, \sum_{i=1}^n \lambda_i = 1 \right\}
\end{equation}

In the context of optimization, this property is useful for formulating constraints, as a constraint on a B-spline function can be enforced by imposing them on the control points \citep{mercy2017spline}. 
\begin{equation}
    a \leq c_i \leq b \quad \forall i\in\{1,2,\ldots,n\} \implies a \leq f(x) \leq b \quad \forall x
\end{equation}
Here $a$ and $b$ are constants of appropriate dimensions and the $\leq$ operator is applied element-wise.

\section{Operations on B-splines}
From the recursive relation in \cref{eq:b-spline-recurrence} it follows that the B-spline basis functions are piecewise polynomial functions in $x$ of degree $p$. This property makes it clear that all polynomial operations on B-splines will result in a new B-spline. Some 


\section{Differentiation}\label{sec:derivative}
Given a B-spline $f(x) = \sum_{j=0}^{n-1} c_j B_{j, p, \mathbf{t}}(x)$,
the derivative of the B-spline can be computed by simply differencing its coefficients. 
\begin{equation}\label{eq:b-spline-derivative}
    \frac{d}{dx} f(x) = (p-1) \sum_{j=1}^{n-1} \frac{c_j-c_{j-1}}{t_{j+p-1}-t_j} B_{j, p-1, \boldsymbol{\tau}}(x)
\end{equation}
where $\boldsymbol{\tau} = [t_j]_{j=1}^{n+p-1}$ is the same knot vector as $\mathbf{t}$, but with the first and last knot removed in order to maintain \todo{finn ord som passer}.

The new coefficients can be expressed using a transformation matrix $\mathbf T_D$ such that $\mathbf{c}_D = \mathbf T_D \mathbf{c}$, where $\mathbf{c}_D$ is the vector of coefficients of the derivative B-spline. The transformation matrix is then an $(n-1) \times n$ matrix with elements:

\begin{equation}
    \mathbf T_D = (p-1) \begin{bmatrix}
        -q_{1,p-1,\mathbf{t}}^{-1} & q_{1,p-1,\mathbf{t}}^{-1} & 0 & \cdots & 0 \\
        0 & -q_{2,p-1,\mathbf{t}}^{-1} & q_{2,p-1,\mathbf{t}}^{-1} & \cdots & 0 \\
        \vdots & \vdots & \vdots & \ddots & \vdots \\
        0 & \cdots & 0 & -q_{n-1,p-1,\mathbf{t}}^{-1} & q_{n-1,p-1,\mathbf{t}}^{-1} 
    \end{bmatrix},
\end{equation}
where $q_{j,p,\mathbf{t}} = (t_{j+p}-t_j)$.


The denominator $t_{j+p}-t_j$ in \cref{eq:b-spline-derivative} illustrates the continuity of the B-spline with respect to knot multiplicity. If a knot is repeated more than $p$ times, the denominator will be zero, and the derivative is not defined at that knot.

\section{Integration}
Given a degree $p$ and initial knot sequence $\mathbf t$, \cref{eq:b-spline-derivative}, gives
\begin{equation}\label{eq:b-spline-integral-pre}
    p \sum_{j=1}^{n-1} \gamma_j B_{j, p, \boldsymbol{t}}(x) 
    = \frac{d}{dx} \sum_{j=0}^{n-1} c_j B_{j, p+1, \boldsymbol{\tau}}(x),
\end{equation}
given that
\begin{equation}
    \gamma_j = \frac{c_j-c_{j-1}}{t_{j+p}-t_j},
\end{equation}
holds. Here, $\boldsymbol{\tau}$ is now the knot vector $\mathbf{t}$ with 1 additional knot at the beginning and end. Now
the new coefficients on the right hand side of \cref{eq:b-spline-integral-pre} can be expressed as 
\begin{equation}\label{eq:b-spline-integral-coefficients}
    c_j = c_{j-1} + \gamma_j \frac{t_{j+p}-t_j}{p}.
\end{equation}
This then gives the general anti-derivative of a B-spline as
\begin{equation}\label{eq:b-spline-integral}
    \int f(x) dx = \sum_{j=0}^{n-1} c_j B_{j, p+1, \boldsymbol{\tau}}(x)
\end{equation}
where $[c_j]_{j=1}^{n-1}$ are given by \cref{eq:b-spline-integral-coefficients}, $c_0$ is the constant of integration and $[\gamma_j]_1^{n-1}$ are the original coefficients of $f(x)$. In matrix form, the coefficients of the integral B-spline can be expressed as
\begin{equation}\label{eq:b-spline-integral-matrix}
    \mathbf{c}_I = \mathbf T_I \mathbf{c} + \mathbf{c}_0,
\end{equation}
where $\mathbf T_I$ is an $n \times (n-1)$ matrix with elements
\begin{equation}
    \mathbf T_I = \frac{1}{p}\begin{bmatrix}
        0 & 0 & \cdots & 0 \\
        q_{1,p,\mathbf{t}} & 0 & \cdots & 0 \\
        q_{1,p,\mathbf{t}} & q_{2,p,\mathbf{t}} & \cdots & 0 \\
        \vdots & \vdots & \ddots & \vdots \\
        q_{1,p,\mathbf{t}} & q_{2,p,\mathbf{t}} & \cdots & q_{n-1,p,\mathbf{t}}
    \end{bmatrix},\quad
    \mathbf{c}_0 = \begin{bmatrix}
        c_0 \\
        c_0 \\
        \vdots \\
        c_0
    \end{bmatrix}
\end{equation}

and $q_{j,p,\mathbf{t}} = (t_{j+p}-t_j)$ still.
As integration and differentiation are inverse operations, it should come as no surprise that the transformation matrices $\mathbf T_I$ and $\mathbf T_D$ are similirly related. This is explored further in \cref{app:homogeneous-integration-matrix}.


\section{Knot Refinement and Degree Elevation}
In order to perform binary operations on spline functions such as multiplication and addition, it is necessary to be able to represent the same spline function in different bases. A powerful result from theory is that any spline function $\mathbf S$ expressed in a given basis $\mathbf B_{p,\mathbf t}$ can be represented in any other basis $\mathbf B_{q,\boldsymbol \tau}$ as long as $q \geq p$ and $\mathbf t \subseteq \boldsymbol \tau$. Moreover, the coefficients of the new basis can be found by solving a linear system of equations. This is the core idea behind the knot refinement and degree elevation algorithms presented here.

The goal is to find the transformation matrix $\mathbf T$ such that $\mathbf c_{q, \boldsymbol \tau} = \mathbf T \mathbf c_{p, \mathbf t}$, where $\mathbf c_{q, \boldsymbol \tau}$ and $\mathbf c_{p, \mathbf t}$ are the coefficients of the spline function $\mathbf S$ in the bases $\mathbf B_{q,\boldsymbol \tau}$ and $\mathbf B_{p,\mathbf t}$, respectively.

%The strategy to find $\mathbf T$ involves expressing the coefficients of the original basis $\mathbf c_{p, \mathbf t}$ as a linear combination of the refined basis $\mathbf c_{q,\boldsymbol \tau}$.
Noting that the two spline functions $\mathbf B_{q,\boldsymbol \tau}^\top \mathbf c_{q, \boldsymbol \tau}$, $\mathbf B_{p,\mathbf t}^\top \mathbf c_{p, \mathbf t}$ have to be equal,
the transformation matrix $\mathbf T$ can be found by sampling the B-spline basis functions at strategic points in the interval $[\tau_0, \tau_{n+q})$ to obtain a system of $m$ linear equations with $m$ unknowns.

The Greville abscissae $\boldsymbol \zeta_{q,\boldsymbol \tau}=[\zeta_{q,\boldsymbol \tau}]_{i=0}^{n-1}$ are a natural choice for the sampling points, as they represent the points at which the $i$-th basis function is most influential. 
They are given by the mean of the knots in the knot span  of each basis function$[\tau_i, \tau_{i+q+1})$ as
\begin{equation}
    \zeta_{q,\boldsymbol \tau}(i) = \frac{1}{q+1} \sum_{j=i}^{i+q} \tau_j.
\end{equation}
The transformation matrix $\mathbf T$ can then be found by evaluating the B-spline basis functions at the Greville abscissae and solving the linear system of equations
\begin{equation}
    \mathbf B_{q,\boldsymbol \tau}(\zeta_{q,\boldsymbol \tau}(i))^\top \mathbf c_{q, \boldsymbol \tau} = \mathbf B_{p,\mathbf t}(\zeta_{q,\boldsymbol \tau}(i))^\top \mathbf c_{p, \mathbf t} \quad \forall i\in\{0,1,\ldots,m-1\}
\end{equation}
for $\mathbf c_{q, \boldsymbol \tau}$. This can be written in matrix form as
\begin{equation}
    \underbrace{\begin{bmatrix}
        \mathbf B_{q,\boldsymbol \tau}(\zeta_{q,\boldsymbol \tau}(0))^\top \\
        \mathbf B_{q,\boldsymbol \tau}(\zeta_{q,\boldsymbol \tau}(1))^\top \\
        \vdots                                                             \\
        \mathbf B_{q,\boldsymbol \tau}(\zeta_{q,\boldsymbol \tau}(m-1))^\top
    \end{bmatrix}}_{m \times m}
    \underbrace{\begin{bmatrix}
        c_{q, \boldsymbol \tau, 0}   \\
        c_{q, \boldsymbol \tau, 1}   \\
        \vdots                       \\
        c_{q, \boldsymbol \tau, m-1} \\
    \end{bmatrix}}_{m \times 1}
    = 
    \underbrace{\begin{bmatrix}
        \mathbf B_{p,\mathbf t}(\zeta_{q,\boldsymbol \tau}(0))^\top  \\
        \mathbf B_{p,\mathbf t}(\zeta_{q,\boldsymbol \tau}(1))^\top  \\
        \vdots                                                       \\
        \mathbf B_{p,\mathbf t}(\zeta_{q,\boldsymbol \tau}(m-1))^\top
    \end{bmatrix}}_{m \times n}
    \underbrace{\begin{bmatrix}
        c_{p, \mathbf t, 0}   \\
        c_{p, \mathbf t, 1}   \\
        \vdots                \\
        c_{p, \mathbf t, n-1}
    \end{bmatrix}}_{n \times 1},
\end{equation}
or more compactly as
\begin{equation}
    [\mathbf B_{q,\boldsymbol \tau}(\boldsymbol \zeta_{q,\boldsymbol \tau})^\top] \mathbf c_{q, \boldsymbol \tau} = [\mathbf B_{p,\mathbf t}(\boldsymbol \zeta_{q,\boldsymbol \tau})^\top] \mathbf c_{p, \mathbf t}.
\end{equation}

The matrix $\mathbf T$ is then simply
\begin{equation}
    \mathbf T = [\mathbf B_{q,\boldsymbol \tau}(\boldsymbol \zeta_{q,\boldsymbol \tau})^\top]^{-1} [\mathbf B_{p,\mathbf t}(\boldsymbol \zeta_{q,\boldsymbol \tau})^{\top}].
\end{equation}

\begin{example}[Degree Elevation]
    We want to express the constant spline $f(x) =\mathbf B_{0, \mathbf t}^\top\mathbf c$ with knot vector $\mathbf t = \left[0, 1\right]$ as a linear spline $g(x) = \mathbf B_{1, \boldsymbol \tau}^\top \mathbf d$ with knot vector $\boldsymbol \tau = \left[0, 0, 1, 1\right]$. 

    The Greville abscissae for the linear spline are 
    \begin{equation*}
        \boldsymbol \zeta_{1,\boldsymbol \tau} = 
        \begin{bmatrix}
            \frac{\tau_0 + \tau_1 + \tau_2}{3} &
            \frac{\tau_1 + \tau_2 + \tau_3}{3} 
        \end{bmatrix}
        =
        \begin{bmatrix}
            \frac{0 + 0 + 1}{3} & \frac{0 + 1 + 1}{3}
        \end{bmatrix} = \begin{bmatrix}
            \frac{1}{3} & \frac{2}{3}
        \end{bmatrix}.
    \end{equation*}
    Evaluating $\mathbf B_{0, \mathbf t}$ and $\mathbf B_{1, \boldsymbol \tau}$  at the Greville abscissae gives\todo{legg til plot av konstant spline og linear spline}
    \begin{equation*}
        \begin{aligned}
            \mathbf B_{0, \mathbf t}\begin{pmatrix}\frac{1}{3}\end{pmatrix} &= \begin{bmatrix} 1 \end{bmatrix}, 
            &\mathbf B_{0, \mathbf t}\begin{pmatrix}\frac{2}{3}\end{pmatrix} &= \begin{bmatrix} 1 \end{bmatrix} 
            \\
            \mathbf B_{1, \boldsymbol \tau}\begin{pmatrix}\frac{1}{3}\end{pmatrix} &= \begin{bmatrix} \frac{2}{3} & \frac{1}{3} \end{bmatrix}^\top, 
            &\mathbf B_{1, \boldsymbol \tau}\begin{pmatrix}\frac{2}{3}\end{pmatrix} &= \begin{bmatrix} \frac{1}{3} & \frac{2}{3} \end{bmatrix}^\top
        \end{aligned}
    \end{equation*}
    Solving
    \begin{equation*}
        \begin{bmatrix}
            \frac{2}{3} & \frac{1}{3} \\
            \frac{1}{3} & \frac{2}{3}
        \end{bmatrix}
        \begin{bmatrix}
            d_0 \\
            d_1
        \end{bmatrix}
        =
        \begin{bmatrix}
            1 \\
            1
        \end{bmatrix}
        \begin{bmatrix}
            c_0
        \end{bmatrix}
    \end{equation*}
    gives the solution
    \begin{equation*}
        \begin{bmatrix}
            d_0 \\
            d_1
        \end{bmatrix}
        =
        \begin{bmatrix}
            2 & -1 \\
            -1 & 2
        \end{bmatrix}
        \begin{bmatrix}
            1 \\
            1
        \end{bmatrix}
        \begin{bmatrix}
            c_0
        \end{bmatrix}
        =
        \begin{bmatrix}
            1 \\
            1
        \end{bmatrix}
        \begin{bmatrix}
            c_0
        \end{bmatrix}
    \end{equation*}
\end{example}


\begin{example}[Knot Refinement]
    Given a linear spline function $f(x) = \mathbf B_{1, \mathbf t}^\top \mathbf c$ with knot vector $\mathbf t = \begin{bmatrix} 0 & 0 & \frac{1}{2} & 1 & 1\end{bmatrix}$, the goal is to express it with in the basis $\mathbf B_{1, \boldsymbol \tau}$ with the refined knot vector $\boldsymbol \tau = \begin{bmatrix} 0 & 0 & \frac{1}{4} & \frac{1}{2} & \frac{3}{4} & 1 & 1\end{bmatrix}$.

    The Greville abscissae for the refined basis are
    \begin{equation*}
        \boldsymbol \zeta_{1,\boldsymbol \tau} = 
        \begin{bmatrix}
            \frac{1}{12} & \frac{3}{12} & \frac{6}{12} & \frac{9}{12} & \frac{11}{12}
        \end{bmatrix}.
    \end{equation*}
    Using \cref{tab:linear-spline-evaluation} to evaluate the B-spline basis functions at the Greville abscissae gives
    \begin{equation*}
        \begin{aligned}
            \mathbf B_{1, \mathbf t}\begin{pmatrix}\frac{1}{12}\end{pmatrix} &= \begin{bmatrix} \frac{3}{4} & \frac{1}{4} & 0 & 0 & 0 \end{bmatrix}^\top,
            &\mathbf B_{1, \mathbf t}\begin{pmatrix}\frac{3}{12}\end{pmatrix} &= \begin{bmatrix} 0 & 1 & 0 & 0 & 0 \end{bmatrix}^\top, \\
            \mathbf B_{1, \mathbf t}\begin{pmatrix}\frac{6}{12}\end{pmatrix} &= \begin{bmatrix} 0 & 1 & 0 & 0 & 0 \end{bmatrix}^\top,
            &\mathbf B_{1, \mathbf t}\begin{pmatrix}\frac{9}{12}\end{pmatrix} &= \begin{bmatrix} 0 & 0 & 0 & 1 & 0 \end{bmatrix}^\top, \\
            \mathbf B_{1, \mathbf t}\begin{pmatrix}\frac{11}{12}\end{pmatrix} &= \begin{bmatrix} 0 & 0 & 0 & \frac{1}{4} & \frac{3}{4} \end{bmatrix}^\top.
        \end{aligned}
    \end{equation*}

    \begin{table*}[h]
        \centering
        \begin{tabular}{c|c|c|c|c|c}
            Knot Interval & $\mathbf B_{1, \boldsymbol\tau, 0}(x)$ & $\mathbf B_{1, \boldsymbol\tau, 1}(x)$ & $\mathbf B_{1, \boldsymbol\tau, 2}(x)$ & $\mathbf B_{1, \boldsymbol\tau, 3}(x)$ & $\mathbf B_{1, \boldsymbol\tau, 4}(x)$ \\
            \hline
            \rule{0pt}{2.5ex} $\left[0,\frac{1}{4}\right]$ & $1-4x$ & $4x$ & 0 & 0 & 0 \\[5pt]
            \rule{0pt}{2.5ex} $\left[\frac{1}{4},\frac{1}{2}\right]$ & 0 & $2-4x$ & $-1+4x$ & 0 & 0 \\[5pt]
            \rule{0pt}{2.5ex} $\left[\frac{1}{2},\frac{3}{4}\right]$ & 0 & 0 & $3-4x$ & $-2+4x$ & 0 \\[5pt]
            \rule{0pt}{2.5ex} $\left[\frac{3}{4},1\right]$ & 0 & 0 & 0 & $4-4x$ & $-3+4x$ \\[5pt]
        \end{tabular}
        \caption{The polynomial functions of each basis function in the knot intervals}
        \label{tab:linear-spline-evaluation}
    \end{table*}
\end{example}

\section{Knot Insertion}
In order to perform binary operations on spline functions (e.g. addition and Multiplication), it is convenient to have them be represeted in the same basis, e.g., have the same degree and knot vector. If this is not the case, the B-splines must be transformed to a common form. This motivates the need for operations that can transform B-splines between different bases without changing the shape of the curve. The explanations in this section are based on lecture notes from \cite{bspline-uio}.

Knot insertion is, as the name suggests, the operation of extending the knot vector by adding new knots. Given a spline function $f(x) = \mathbf{c}^{\top} \mathbf{B}_{p, \mathbf{t}}(x)$ with knot vector $\mathbf t$, the goal is to express the same function in a new basis $\mathbf{B}_{p, \boldsymbol{\tau}}(x)$ with knot vector $\boldsymbol{\tau}$.

A simple example of a knot vector $\mathbf t$ and a refinement $\boldsymbol \tau$ is given by
$$
    \mathbf t = [0, 0, 0, 0, 1, 2, 3, 5, 5, 5, 5], \quad \boldsymbol \tau = [0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 4, 5, 5, 5, 5].
$$
Here two knots have been added at 1, one at 2, and one at 4.

To relate the coefficients of the B-spline in the original basis to the refined basis, one can use so-called discrete B-splines \citep{Cohen1980}. \todo{Forklar subskript $\tau$} The B-spline basis $B_{j, p, \boldsymbol{\tau}}(x)$ and its discrete counterpart $\alpha_{j,p, \boldsymbol{\tau}, \mathbf t}(i)$ are related by setting $x = t_{i+p}$ for $B_{j, d, \boldsymbol{\tau}}(x)$ in \cref{eq:b-spline-recurrence-p}, 
\begin{equation}\label{eq:discrete-b-spline-recurrence-p}
    \alpha_{j,p}(i) = B_{j, p, \boldsymbol{\tau}}(t_{i+p}) = 
    \frac{t_{i+p}-\tau_j}{\tau_{j+p}-\tau_j} \alpha_{j,p-1}(i) + \frac{\tau_{j+1+p}-t_{i+p}}{\tau_{j+1+p}-\tau_{j+1}} \alpha_{j+1,p-1}(i)
\end{equation}
and 
\begin{equation}\label{eq:discrete-b-spline-recurrence-0}
\alpha_{j,0}(i) = B_{j, 0, \boldsymbol{\tau}}(t_{i}) = \mathbf 1_{[\tau_j, \tau_{j+1})}(t_{i})
\end{equation}
 in \cref{eq:b-spline-recurrence-0}. Notice that $t_i$ is used instead of $t_{i+p}$ in \cref{eq:discrete-b-spline-recurrence-0}. Intuitively, this can be thought of as weighting the contributions from the knot vector $\mathbf t$ to the new knot vector $\boldsymbol \tau$ in the interval of the new knot span $[\tau_j, \tau_{j+1})$. The interested reader is referred to \cite{bspline-uio} for a more detailed derivation.

With the discrete B-splines, the transformation matrix $\mathbf A$ that relates the coefficients of the B-spline in the original basis $\mathbf c$ to the coefficients in the refined basis $\mathbf c'$ can now be found. Each row $A_i$ of $\mathbf A = [A_i^T]_0^{m-1}$ is given by selecting a non-empty knot span $[\tau_\mu, \tau_{\mu+1})$ in the refined basis and computing the corresponding discrete B-spline values $\alpha_{j,p}(\mu)$ for all $j$ in the original basis, which is summarized in \cref{alg:knot-insertion}.

\begin{algorithm}
    \caption{Naive Knot Insertion}\label{alg:knot-insertion}
    \begin{algorithmic}
        \For {$i = 0$ to $m-1$}
        \State Determine $\mu$ such that $t_i \in [\tau_\mu, \tau_{\mu+1})$
        \State Compute $A_i = [\alpha_{j,p}(\mu)]_{j=0}^{n-1}$
        \EndFor
    \end{algorithmic}
\end{algorithm}

This is also the core idea of the Oslo algorithm \citep{Cohen1980}, for which \cref{alg:knot-insertion} is a simplified version. The complete Oslo algorithm avoids computing zero-valued coefficients in the transformation matrix $\mathbf A$ by making use of the fact that $\alpha_{j,p}(\mu) = 0$ if $t_i \notin [\tau_{\mu-p}, \tau_{\mu})$. The full Oslo algorithm is given in \cref{alg:oslo-knot-insertion}.

\begin{algorithm}
    \caption{Oslo Algorithm}\label{alg:oslo-knot-insertion}
    \begin{algorithmic}
        \For {$i = 0$ to $m-1$}
        \State Determine $\mu$ such that $t_i \in [\tau_\mu, \tau_{\mu+1})$
        \State Set $A_i = [A_{i,j}]_{j=0}^{n-1} = \mathbf 0$
        \State Compute entries $[A_{i,j}]_{j=\mu-p}^\mu = [\alpha_{j,p}(\mu)]_{j=\mu-p}^{\mu}$
        \EndFor
    \end{algorithmic}
\end{algorithm}

\section{Degree Elevation}

The goal of degree elevation is to express a spline function $f(x) = \mathbf{c}^{\top} \mathbf{B}_{p, \mathbf{t}}(x)$ in a new basis $\mathbf{B}_{p+1, \boldsymbol{\tau}}(x)$ with a higher degree $p+1$. 

There are many ways to elevate the degree of a B-spline \citep{piegl1994,Prautzsch1984,lee2000degree} with different strengths and weaknesses in regards to computational complexity and implementation. one of the simpler methods to implement is developed by \cite{Cohen1986} and will be presented here.

Given a knot sequence
\begin{equation}
    \mathbf t = \big[\underbrace{t_0, \ldots, t_0}_{p+1}, \underbrace{t_1, \ldots, t_1}_{m_1}, \ldots, \underbrace{t_k, \ldots, t_k}_{m_k}, \ldots, \underbrace{t_{n-1}, \ldots, t_{n-1}}_{p+1}\big],
\end{equation}

the continuity of the spline function is determined by its degree $p$ and knot multiplicity $m_k$ in that it has $p-m_k-1$ continuous derivatives in a neighbourhood around $t_k$ \citep{Cohen1986}.
Since the degree-elevated B-spline represents the same spline function it should also have the same continuity. The new knot sequence $\boldsymbol \tau$ is then given by increasing the multiplicity of each knot in $\mathbf t$ by 1:
\begin{equation}\label{eq:degree-elevation-knots}
    \boldsymbol \tau = \big[\underbrace{t_0, \ldots, t_0}_{p+2}, \underbrace{t_1, \ldots, t_1}_{m_1+1}, \ldots, \underbrace{t_k, \ldots, t_k}_{m_k+1}, \ldots, \underbrace{t_{n-1}, \ldots, t_{n-1}}_{p+2}\big].
\end{equation}

There are two key ideas needed do find the new coefficients:
\begin{enumerate}
    \item The $k$-th of the B-splines are equal to each other for all $k\in\mathbb{N}_+$.
    \item The $p$-th derivative of the B-splines are zero.
\end{enumerate}
For the second point to be true, the new coefficients $\mathbf{\tilde c}$ must satisfy
\begin{equation}
    \frac{d^p}{dx^p} f(x) = 0 \Rightarrow \frac{d^p}{dx^p} \mathbf{c}^{\top} \mathbf{B}_{p, \mathbf{t}}(x) = 
    \frac{d^p}{dx^p} \mathbf{\tilde c}^{\top} \mathbf{B}_{p+1, \boldsymbol{\tau}}(x) = 0,
\end{equation}
which is only possible if $\mathbf{\tilde c}^p = \mathbf 0$. From here, the integral matrix $\mathbf T_I$ can be used to find the new coefficients $\mathbf{\tilde c}$, setting $\mathbf{\tilde c}_0^p = \mathbf 0, \mathbf{\tilde c}_0^k = \mathbf c_0^k$, and applying the integral matrix $k$ times:
\begin{equation}\label{eq:degree-elevation-coefficients}
    \begin{aligned}
        \mathbf{\tilde c}^k &= \mathbf T^{k+1}_{I,\boldsymbol\tau} \mathbf{\tilde c}^{k+1} + \mathbf{c}_0^{k} \\
        \mathbf{\tilde c} &= \mathbf{\tilde c}^0
    \end{aligned}
\end{equation}
Here, $\mathbf T^k_{I,\boldsymbol\tau}$ is the integral matrix for the $k$-th derivative of the B-spline basis functions with knot vector $\boldsymbol\tau$, and $\mathbf{c}^k = [c_0^k]_{j=1}^{n+1-k}$ is a vector of appropriate length with all elements set to the first coefficient of the $k$-th derivative. This is summarized in \cref{alg:degree-elevation}, which is a simplified version of the degree elevation algorithm presented by \cite{lee2000degree}. \todo{forklar regular knot vector}

\begin{algorithm}
    \caption{Degree Elevation}\label{alg:degree-elevation}
    \begin{algorithmic}
        \State Let $\mathbf B_{p, \mathbf t}(x)$ be the B-spline basis with degree $p$ and regular knot vector $\mathbf t$, and $\mathbf B_{p+1, \boldsymbol \tau}(x)$ be the basis with $\boldsymbol \tau$ given by \cref{eq:degree-elevation-knots}.
        \For {$k = p$ to $0$}
            \State Compute $\mathbf{\tilde c}^k$ from \cref{eq:degree-elevation-coefficients}.
        \EndFor
    \end{algorithmic}
\end{algorithm}

\section{Addition and Subtraction}

Finding the sum or difference of two B-splines that share the same basis is a simple task as the coefficients can just be added together:
\begin{equation}
    f(x) \pm g(x) = \mathbf{c}_1^{\top} \mathbf{B}_{p, \mathbf{t}}(x) \pm \mathbf{c}_2^{\top} \mathbf{B}_{p, \mathbf{t}}(x) 
    =(\mathbf{c}_1 \pm \mathbf{c}_2)^{\top} \mathbf{B}_{p, \mathbf{t}}(x)
\end{equation}
However, if the B-splines are in different bases, they must be transformed to a common basis before the addition can be performed. More formalized the problem is as follows: For the spline functions $f(x) = \mathbf{c}_1^{\top} \mathbf{B}_{p, \mathbf{t}_1}(x)$ and $g(x) = \mathbf{c}_2^{\top} \mathbf{B}_{q, \mathbf{t}_2}(x)$, with degrees $p$ and $q$ and knot vectors $\mathbf t_1$ and $\mathbf t_2$, the goal is to find a common basis $\mathbf{B}_{r, \boldsymbol{\tau}}(x)$ with degree $r$ and knot vector $\boldsymbol{\tau}$ such that $h(x) = \mathbf d^{\top} \mathbf{B}_{r, \boldsymbol{\tau}}(x) = f(x) + g(x)$. To do this, the degree elevation and knot insertion algorithms presented in the previous sections can be used. The full algorithm is given in \cref{alg:addition}.

\begin{algorithm}
    \caption{Addition}\label{alg:addition}
    \begin{algorithmic}
        \State Find the degree $r = \max(p, q)$
        \State Elevate the degree of the B-splines to $r$ using \cref{alg:degree-elevation} to get $\mathbf c_1'^\top\mathbf B_{r, \mathbf t_1'}(x)$ and $\mathbf c_2'^\top\mathbf B_{r, \mathbf t_2'}(x)$.
        \State Find the common basis $\boldsymbol{\tau}$ as the union of $\mathbf t_1$ and $\mathbf t_2$, setting the multiplicity of each knot to the maximum of the two.
        \State Find the transformation matrices $\mathbf A_1$ from $\mathbf B_{r, \mathbf t_1'}(x)$ to $\mathbf B_{r, \boldsymbol{\tau}}(x)$ and $\mathbf A_2$ from $\mathbf B_{r, \mathbf t_2'}(x)$ to $\mathbf B_{r, \boldsymbol{\tau}}(x)$ using \cref{alg:oslo-knot-insertion}.
        \State The new basis is then $\mathbf B_{r, \boldsymbol{\tau}}(x)$ with coefficients $\mathbf{d} = \mathbf A_1 \mathbf c'_1 + \mathbf A_2 \mathbf c'_2$
    \end{algorithmic}
\end{algorithm}




\section{Multiplication and Dot Product}

